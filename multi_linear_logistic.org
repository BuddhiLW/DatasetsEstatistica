#+LATEX_CLASS: article
#+LaTeX_HEADER: \usepackage{minted}
#+LaTeX_HEADER: \usemintedstyle{}
#+LaTeX_HEADER: \usepackage[hidehyperlinks]{hyperref}

* Infarto
  
** Download de pacotes
*** Fixando Repositório   
[[https://stackoverflow.com/questions/1189759/expert-r-users-whats-in-your-rprofile/1189826#1189826][Fix repository from Brazil]]
#+NAME: eeff5bf3-47d1-4848-833a-b61dd43f5c8c
#+begin_src ein-r :session localhost :results output
  r = getOption("repos")  # hard code the BR repo for CRAN
  r["CRAN"] = "https://vps.fmvz.usp.br/CRAN/" # usp repository
  options(repos = r)
  ## rm(r)
#+end_src

#+RESULTS: eeff5bf3-47d1-4848-833a-b61dd43f5c8c

*** Instalando pacotes

#+NAME: 415f762e-5134-4d83-8c3d-43d09629563b
#+begin_src ein-r :session localhost :results output
  install.packages(c("tidyverse","janitor","glmnet","ggthemes","patchwork"))
#+End_src

#+RESULTS: 415f762e-5134-4d83-8c3d-43d09629563b
: 
: 

*** Chamando os pacotes
#+NAME: 6d605b1d-a0eb-4e51-8e9b-8060e2e26616
#+begin_src ein-r :session localhost :results output
  library(tidyverse)
  library(janitor)
#  library(glmnet)
  library(ggthemes)
  library(patchwork)
#+end_src

#+RESULTS: 6d605b1d-a0eb-4e51-8e9b-8060e2e26616

*** Lendo os dados e os limpando, para um r-Dataset

    #+NAME: 76d3253a-7165-4bb4-b0da-d17838e7af72
    #+begin_src ein-r :session localhost :results output :export no
      heart_data <-
      readr::read_csv("~/PP/MonitoriaEstatistica/data/csv/infarto_logistica.csv")%>% janitor::clean_names() %>% janitor::remove_empty(which = "rows") %>% as.data.frame() %>% na.omit()
    #+end_src

    #+RESULTS: 76d3253a-7165-4bb4-b0da-d17838e7af72
    : 
    : 
    : 
**** Para export e boa formatação
     Para rodar, precisa-se tirar os espaçõs entre linhas. Isto é,
     fazer o commando de uma linha; totalmente concatenado.
     
#+NAME: 70c36cbd-b400-4f36-860b-6bc8015e94f9
#+begin_src ein-r :session localhost :results output
  heart_data <-
  readr::read_csv("~/PP/MonitoriaEstatistica/data/csv/infarto_logistica.csv")
  %>% janitor::clean_names()
  %>% janitor::remove_empty(which = "rows")
  %>% as.data.frame()
  %>% na.omit()
#+end_src

#+RESULTS: 70c36cbd-b400-4f36-860b-6bc8015e94f9
: 
: 
: 

*** Olhando os dados
#+NAME: d1fdc41a-cb06-4590-ae95-0806fb25c246
#+begin_src ein-r :session localhost :results output table
heart_data[1:10,]
#+end_src

#+RESULTS: d1fdc41a-cb06-4590-ae95-0806fb25c246

| age anemia creatinofosfoquinase diabetes fracao_ejecao_normal pressao_alta |
|----------------------------------------------------------------------------|
| 1  75  0       582                 0        20                   1       |
| 2  55  0      7861                 0        38                   0         |
| 3  65  0       146                 0        20                   0         |
| 4  50  1       111                 0        20                   0         |
| 5  65  1       160                 1        20                   0         |
| 6  90  1        47                 0        40                   1         |
| 7  75  1       246                 0        15                   0         |
| 8  60  1       315                 1        60                   0         |
| 9  65  0       157                 0        65                   0         |
| 10 80  1       123                 0        35                   1         |
|----------------------------------------------------------------------------|
| plaquetas serum_creatinina serum_sodio sexo fumante horario morte          |
| 1  265000    1.9              130         1    0        4      1           |
| 2  263358    1.1              136         1    0        6      1           |
| 3  162000    1.3              129         1    1        7      1           |
| 4  210000    1.9              137         1    0        7      1           |
| 5  327000    2.7              116         0    0        8      1           |
| 6  204000    2.1              132         1    1        8      1           |
| 7  127000    1.2              137         1    0       10      1           |
| 8  454000    1.1              131         1    1       10      1           |
| 9  263358    1.5              138         0    0       10      1           |
| 10 388000    9.4              133         1    1       10      1           |

*** Separando o conjunto entre treino e validação (teste)
#+NAME: 6d5a01d1-8100-4397-a843-b1b2f83fd387
#+begin_src ein-r :session localhost :results output
  set.seed(1234)

  trein <- sample(1:nrow(heart_data), round(0.8 * nrow(heart_data), digits = 0))
  test <- setdiff(1:nrow(heart_data), train)

  heart_data_train_x <- model.matrix(object = morte ~ ., data = heart_data[train, ])[, -1]
  heart_data_train_y <- factor(heart_data[train, "morte"])

  success_rates <- vector(mode = "double", length = 3)
  names(success_rates) <- c("lasso", "ridge", "logistic")
#+end_src

#+RESULTS: 6d5a01d1-8100-4397-a843-b1b2f83fd387

*** glm (General Linear Model) é uma regressão logística
    A função =glm= é extremamente poderosa, e no caso a sintaxe lê-se
    como: faça um modelo linear de forma com que prediza-se a morte 
#+NAME: d160d4e1-8dee-4daa-b499-99b1ebb1aac3
#+begin_src ein-r :session localhost :results output
glm_heart_model <- glm(formula = morte ~ ., data = heart_data[train, ], family = "binomial")
#+end_src

#+RESULTS: d160d4e1-8dee-4daa-b499-99b1ebb1aac3

#+NAME: 21dc6a32-466e-4958-8d4b-9a31a4fe367a
#+begin_src ein-r :session localhost :results output
  glm_heart_predict <- predict(object = glm_heart_model, newdata = heart_data[test, ], type = "response")

  glm_heart_classes <- ifelse(glm_heart_predict > 0.5, 1, 0)


  success_rates["logistic"] <- round(mean(ifelse(glm_heart_classes == heart_data[test, "morte"], 1, 0)), digits = 2)

  success_rates["logistic"]

  table(glm_heart_classes, heart_data[test, "morte"])
#+end_src

#+RESULTS: 21dc6a32-466e-4958-8d4b-9a31a4fe367a


- *logistic*: 0.85 
	|-------------------+----+----|
	| glm_heart_classes |  0 |  1 |
	|                 0 | 38 |  4 |
	|                 1 |  5 | 13 |
	|-------------------+----+----|


#+NAME: 2c6f8b44-704e-4cb8-829d-0970a862c1bb
#+begin_src ein-r :session localhost :results output
  summary(heart_data)
#+end_src

#+RESULTS: 2c6f8b44-704e-4cb8-829d-0970a862c1bb
#+begin_example
      age            anemia       creatinofosfoquinase    diabetes     
 Min.   :40.00   Min.   :0.0000   Min.   :  23.0       Min.   :0.0000  
 1st Qu.:51.00   1st Qu.:0.0000   1st Qu.: 116.5       1st Qu.:0.0000  
 Median :60.00   Median :0.0000   Median : 250.0       Median :0.0000  
 Mean   :60.83   Mean   :0.4314   Mean   : 581.8       Mean   :0.4181  
 3rd Qu.:70.00   3rd Qu.:1.0000   3rd Qu.: 582.0       3rd Qu.:1.0000  
 Max.   :95.00   Max.   :1.0000   Max.   :7861.0       Max.   :1.0000  
 fracao_ejecao_normal  pressao_alta      plaquetas      serum_creatinina
 Min.   :14.00        Min.   :0.0000   Min.   : 25100   Min.   :0.500   
 1st Qu.:30.00        1st Qu.:0.0000   1st Qu.:212500   1st Qu.:0.900   
 Median :38.00        Median :0.0000   Median :262000   Median :1.100   
 Mean   :38.08        Mean   :0.3512   Mean   :263358   Mean   :1.394   
 3rd Qu.:45.00        3rd Qu.:1.0000   3rd Qu.:303500   3rd Qu.:1.400   
 Max.   :80.00        Max.   :1.0000   Max.   :850000   Max.   :9.400   
  serum_sodio         sexo           fumante          horario     
 Min.   :113.0   Min.   :0.0000   Min.   :0.0000   Min.   :  4.0  
 1st Qu.:134.0   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.: 73.0  
 Median :137.0   Median :1.0000   Median :0.0000   Median :115.0  
 Mean   :136.6   Mean   :0.6488   Mean   :0.3211   Mean   :130.3  
 3rd Qu.:140.0   3rd Qu.:1.0000   3rd Qu.:1.0000   3rd Qu.:203.0  
 Max.   :148.0   Max.   :1.0000   Max.   :1.0000   Max.   :285.0  
     morte       
 Min.   :0.0000  
 1st Qu.:0.0000  
 Median :0.0000  
 Mean   :0.3211  
 3rd Qu.:1.0000  
 Max.   :1.0000  
#+end_example

